import React, { useRef, useEffect } from 'react';

/* ---- Color palettes per class ---- */
const PALETTES = {
    Warrior: { 1: '#f5c6a0', 2: '#c0392b', 3: '#e74c3c', 4: '#7f1d1d', 5: '#bdc3c7', 6: '#ecf0f1', 7: '#2c3e50', 8: '#95a5a6', 9: '#d4a76a' },
    Mage: { 1: '#f5c6a0', 2: '#6c3483', 3: '#9b59b6', 4: '#4a235a', 5: '#2e86c1', 6: '#85c1e9', 7: '#1b2631', 8: '#aed6f1', 9: '#f4d03f' },
    Rogue: { 1: '#f5c6a0', 2: '#1e8449', 3: '#27ae60', 4: '#0e6251', 5: '#2c3e50', 6: '#566573', 7: '#1c2833', 8: '#aab7b8', 9: '#d4a76a' },
    Cleric: { 1: '#f5c6a0', 2: '#d4ac0d', 3: '#f1c40f', 4: '#7d6608', 5: '#ecf0f1', 6: '#fdfefe', 7: '#2c3e50', 8: '#f7dc6f', 9: '#f0e68c' },
    Grandmaster: { 1: '#f5c6a0', 2: '#7d3c98', 3: '#a569bd', 4: '#4a235a', 5: '#f4d03f', 6: '#f9e79f', 7: '#1b2631', 8: '#d4ac0d', 9: '#e74c3c' },
};

/* Parse a single frame (array of row-strings) into a 2D numeric array */
const pf = (rows) => rows.map(r => r.split('').map(c => c === '.' ? 0 : parseInt(c, 16)));

/* ---- Frame data: 12 wide × 14 tall, 4 frames per class ---- */
const FRAMES = {
    Warrior: [
        pf([ // idle
            '............',
            '...5665.....',
            '...1111.....',
            '..711117....',
            '..111111....',
            '..233332....',
            '.22333322...',
            '.22344322...',
            '.22322322...',
            '..232232....',
            '..22.222....',
            '..22..22....',
            '..77..77....',
            '............',
        ]),
        pf([ // sword raised
            '......5566..',
            '...5665.55..',
            '...1111.....',
            '..711117....',
            '..111111....',
            '.223333256..',
            '.22333322...',
            '.22344322...',
            '..232232....',
            '..232232....',
            '..22..22....',
            '..77..77....',
            '............',
            '............',
        ]),
        pf([ // idle alt
            '............',
            '...5665.....',
            '...1111.....',
            '..711117....',
            '..111111....',
            '..233332....',
            '.22333322...',
            '.22344322...',
            '.22322322...',
            '..232232....',
            '..22..22....',
            '..77.77.....',
            '............',
            '............',
        ]),
        pf([ // shield bash
            '............',
            '..5665......',
            '..1111......',
            '.711117.....',
            '.111111.....',
            '8823333256..',
            '8823333222..',
            '..2344322...',
            '..232232....',
            '..232232....',
            '..22..22....',
            '..77..77....',
            '............',
            '............',
        ]),
    ],

    Mage: [
        pf([ // idle
            '....444.....',
            '...44344....',
            '...1111.....',
            '..711117....',
            '..111111....',
            '..233332....',
            '.22333322...',
            '.22344322...',
            '..233332....',
            '..22..22....',
            '..22..22....',
            '..77..77....',
            '............',
            '............',
        ]),
        pf([ // casting
            '...999......',
            '..9669......',
            '....444.....',
            '...44344....',
            '...1111.....',
            '..711117....',
            '.2233332....',
            '.22333322...',
            '.22344322...',
            '..233332....',
            '..22..22....',
            '..77..77....',
            '............',
            '............',
        ]),
        pf([ // idle alt
            '....444.....',
            '...44344....',
            '...1111.....',
            '..711117....',
            '..111111....',
            '..233332....',
            '.22333322...',
            '.22344322...',
            '..233332....',
            '..22..22....',
            '..22.22.....',
            '..77.77.....',
            '............',
            '............',
        ]),
        pf([ // big cast
            '..9999......',
            '.966669.....',
            '..9999......',
            '....444.....',
            '...44344....',
            '...1111.....',
            '..711117....',
            '.2233332....',
            '.22333326...',
            '.22344322...',
            '..233332....',
            '..72..27....',
            '..77..77....',
            '............',
        ]),
    ],

    Rogue: [
        pf([ // idle
            '............',
            '...4444.....',
            '...1111.....',
            '..711117....',
            '..111111....',
            '..233332....',
            '.22333322...',
            '.52344325...',
            '..233332....',
            '..22..22....',
            '..22..22....',
            '..77..77....',
            '............',
            '............',
        ]),
        pf([ // lunge
            '............',
            '....4444....',
            '....1111....',
            '...711117...',
            '...111111...',
            '5..233332.5.',
            '55.2333325..',
            '...234432...',
            '...233332...',
            '..22....22..',
            '..22....22..',
            '..77....77..',
            '............',
            '............',
        ]),
        pf([ // idle alt
            '............',
            '...4444.....',
            '...1111.....',
            '..711117....',
            '..111111....',
            '..233332....',
            '.22333322...',
            '.52344325...',
            '..233332....',
            '..22..22....',
            '.22...22....',
            '.77...77....',
            '............',
            '............',
        ]),
        pf([ // backstab
            '............',
            '...4444.....',
            '...1111.....',
            '..711117....',
            '..111111....',
            '.5233332....',
            '.5233332....',
            '..234432..5.',
            '..233332.55.',
            '...22.22....',
            '..22..22....',
            '..77..77....',
            '............',
            '............',
        ]),
    ],

    Cleric: [
        pf([ // idle
            '............',
            '...6666.....',
            '...1111.....',
            '..711117....',
            '..111111....',
            '..533335....',
            '.55333355...',
            '.55344355...',
            '..533335....',
            '..55..55....',
            '..55..55....',
            '..77..77....',
            '............',
            '............',
        ]),
        pf([ // healing
            '...8888.....',
            '..889988....',
            '...8888.....',
            '...6666.....',
            '...1111.....',
            '..711117....',
            '.5533335....',
            '.55333355...',
            '.55344355...',
            '..533335....',
            '..55..55....',
            '..77..77....',
            '............',
            '............',
        ]),
        pf([ // idle alt
            '............',
            '...6666.....',
            '...1111.....',
            '..711117....',
            '..111111....',
            '..533335....',
            '.55333355...',
            '.55344355...',
            '..533335....',
            '..55..55....',
            '..55.55.....',
            '..77.77.....',
            '............',
            '............',
        ]),
        pf([ // big heal
            '..88..88....',
            '...8888.....',
            '..889988....',
            '...8888.....',
            '...6666.....',
            '...1111.....',
            '..711117....',
            '.553333586..',
            '.55333355...',
            '..534435....',
            '..55..55....',
            '..77..77....',
            '............',
            '............',
        ]),
    ],

    Grandmaster: [
        pf([ // regal stance
            '...5555.....',
            '..566665....',
            '...1111.....',
            '..711117....',
            '..111111....',
            '..233332....',
            '.22333322...',
            '.22344322...',
            '..233332....',
            '..22..22....',
            '..22..22....',
            '..55..55....',
            '............',
            '............',
        ]),
        pf([ // scepter raised
            '..555..99...',
            '.566665.9...',
            '..1111.9....',
            '.711117.....',
            '.111111.....',
            '.2333325....',
            '.22333322...',
            '.22344322...',
            '..233332....',
            '..22..22....',
            '..22..22....',
            '..55..55....',
            '............',
            '............',
        ]),
        pf([ // idle alt
            '...5555.....',
            '..566665....',
            '...1111.....',
            '..711117....',
            '..111111....',
            '..233332....',
            '.22333322...',
            '.22344322...',
            '..233332....',
            '..22..22....',
            '.22...22....',
            '.55...55....',
            '............',
            '............',
        ]),
        pf([ // commanding aura
            '..6..6......',
            '..555..99...',
            '.566665.9...',
            '..1111.9....',
            '.711117.....',
            '.111111.....',
            '.2333325....',
            '.22333322...',
            '.22344322...',
            '..233332....',
            '..22..22....',
            '..55..55....',
            '............',
            '............',
        ]),
    ],
};

const PIXEL = 6;
const CW = 12 * PIXEL;
const CH = 14 * PIXEL;

const PixelHero = ({ heroClass = 'Warrior', active = false, size = 64 }) => {
    const canvasRef = useRef(null);
    const frameIdx = useRef(0);
    const timerRef = useRef(null);

    useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const palette = PALETTES[heroClass] || PALETTES.Warrior;
        const frames = FRAMES[heroClass] || FRAMES.Warrior;

        const draw = () => {
            ctx.clearRect(0, 0, CW, CH);
            const f = frames[frameIdx.current % frames.length];
            for (let y = 0; y < f.length; y++) {
                for (let x = 0; x < f[y].length; x++) {
                    const ci = f[y][x];
                    if (ci === 0) continue;
                    // Shadow
                    ctx.fillStyle = 'rgba(0,0,0,0.35)';
                    ctx.fillRect(x * PIXEL + 1, y * PIXEL + 1, PIXEL, PIXEL);
                    // Pixel
                    ctx.fillStyle = palette[ci] || '#ff00ff';
                    ctx.fillRect(x * PIXEL, y * PIXEL, PIXEL, PIXEL);
                }
            }
        };

        const speed = active ? 250 : 500;
        draw();

        if (timerRef.current) clearInterval(timerRef.current);
        timerRef.current = setInterval(() => {
            frameIdx.current = active
                ? (frameIdx.current + 1) % 4           // all 4 frames when active
                : (frameIdx.current === 0 ? 2 : 0);    // idle 0 ↔ 2
            draw();
        }, speed);

        return () => clearInterval(timerRef.current);
    }, [heroClass, active]);

    const scale = size / CW;

    return (
        <canvas
            ref={canvasRef}
            width={CW}
            height={CH}
            style={{
                width: `${size}px`,
                height: `${Math.round(CH * scale)}px`,
                imageRendering: 'pixelated',
                display: 'block',
                margin: '0 auto',
            }}
        />
    );
};

export default PixelHero;
